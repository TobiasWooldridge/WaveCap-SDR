#!/bin/sh

# WaveCap-SDR pre-commit hook
# Runs linting, type checking, and code quality checks before committing

set -e

echo "Running pre-commit checks..."

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"

# ============================================
# Binary guard for CODEX_CLOUD
# ============================================

if [ "${CODEX_CLOUD:-0}" = "1" ]; then
    echo ""
    echo "=== Binary Guard (CODEX_CLOUD enabled) ==="

    # Block committing common binary asset types that cannot be sent from CODEX_CLOUD
    BANNED_EXTENSIONS="png|jpe?g|gif|bmp|tiff?|ico|icns|webp|svg|pdf|zip|tar|gz|tgz|bz2|xz|7z|rar|mp3|mp4|mov|avi|flac|wav|ogg|webm|exe|dll|so|dylib|bin|img|iso"
    BLOCKED_FILES="$(git diff --cached --name-only --diff-filter=AM | grep -Ei "\\.(${BANNED_EXTENSIONS})$" || true)"

    if [ -n "$BLOCKED_FILES" ]; then
        echo "Commit blocked: CODEX_CLOUD=1 cannot send pull requests containing binary assets."
        echo "Remove these files from the commit or unset CODEX_CLOUD to proceed:"
        echo "$BLOCKED_FILES"
        exit 1
    fi
fi

# ============================================
# Frontend checks
# ============================================

echo ""
echo "=== Frontend Checks ==="

cd "$REPO_ROOT/frontend"

# Run lint-staged (ESLint + Prettier on staged files only)
echo "Running lint-staged (ESLint)..."
npx lint-staged

# Run TypeScript type checking
echo "Running TypeScript type check..."
npm run type-check

# ============================================
# Backend checks
# ============================================

echo ""
echo "=== Backend Checks ==="

cd "$REPO_ROOT/backend"

# Check if virtual environment exists and mypy/ruff are available
if [ -d ".venv" ] && [ -f ".venv/bin/mypy" ] && [ -f ".venv/bin/ruff" ]; then
    echo "Running ruff format check..."
    .venv/bin/ruff format --check wavecapsdr
    echo "Running mypy type check..."
    PYTHONPATH=. .venv/bin/mypy wavecapsdr
else
    echo "Error: mypy/ruff not available. Set up the backend venv first."
    echo "Run: cd backend && python3.12 -m venv .venv && source .venv/bin/activate && pip install -e ."
    echo "Then: pip install mypy ruff pytest types-PyYAML"
    exit 1
fi

echo ""
echo "Pre-commit checks passed!"
